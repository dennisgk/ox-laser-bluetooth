"""Extremely simple vector text generation for laser-friendly patterns."""

from __future__ import annotations

from typing import Dict, Iterable, List, Tuple

Point = Tuple[float, float]
Stroke = List[List[float]]

# 5x7 grid-ish single-stroke approximations. Unknown chars fall back to box.
GLYPHS: Dict[str, List[Tuple[Point, Point]]] = {
    "A": [((0, 7), (2.5, 0)), ((2.5, 0), (5, 7)), ((1.2, 4), (3.8, 4))],
    "B": [((0, 0), (0, 7)), ((0, 0), (3.5, 0)), ((3.5, 0), (4.5, 1.2)), ((4.5, 1.2), (3.5, 3)), ((3.5, 3), (0, 3)), ((0, 3), (3.7, 3)), ((3.7, 3), (4.7, 4.5)), ((4.7, 4.5), (3.5, 7)), ((3.5, 7), (0, 7))],
    "C": [((5, 1), (3.5, 0)), ((3.5, 0), (1, 0.8)), ((1, 0.8), (0, 3.5)), ((0, 3.5), (1, 6.2)), ((1, 6.2), (3.5, 7)), ((3.5, 7), (5, 6.2))],
    "D": [((0, 0), (0, 7)), ((0, 0), (3.2, 0.5)), ((3.2, 0.5), (5, 3.5)), ((5, 3.5), (3.2, 6.5)), ((3.2, 6.5), (0, 7))],
    "E": [((5, 0), (0, 0)), ((0, 0), (0, 7)), ((0, 3.5), (4, 3.5)), ((0, 7), (5, 7))],
    "F": [((0, 0), (0, 7)), ((0, 0), (5, 0)), ((0, 3.5), (4, 3.5))],
    "G": [((5, 1.2), (3.6, 0)), ((3.6, 0), (1.2, 0.8)), ((1.2, 0.8), (0, 3.5)), ((0, 3.5), (1.2, 6.3)), ((1.2, 6.3), (3.8, 7)), ((3.8, 7), (5, 5.8)), ((5, 5.8), (5, 4)), ((5, 4), (3.1, 4))],
    "H": [((0, 0), (0, 7)), ((5, 0), (5, 7)), ((0, 3.5), (5, 3.5))],
    "I": [((0, 0), (5, 0)), ((2.5, 0), (2.5, 7)), ((0, 7), (5, 7))],
    "J": [((5, 0), (5, 5.8)), ((5, 5.8), (3.7, 7)), ((3.7, 7), (1.5, 7)), ((1.5, 7), (0.4, 5.7))],
    "K": [((0, 0), (0, 7)), ((5, 0), (0, 3.7)), ((5, 7), (0, 3.7))],
    "L": [((0, 0), (0, 7)), ((0, 7), (5, 7))],
    "M": [((0, 7), (0, 0)), ((0, 0), (2.5, 3.2)), ((2.5, 3.2), (5, 0)), ((5, 0), (5, 7))],
    "N": [((0, 7), (0, 0)), ((0, 0), (5, 7)), ((5, 7), (5, 0))],
    "O": [((1, 0.7), (4, 0.7)), ((4, 0.7), (5, 3.5)), ((5, 3.5), (4, 6.3)), ((4, 6.3), (1, 6.3)), ((1, 6.3), (0, 3.5)), ((0, 3.5), (1, 0.7))],
    "P": [((0, 7), (0, 0)), ((0, 0), (3.8, 0)), ((3.8, 0), (5, 1.5)), ((5, 1.5), (3.8, 3)), ((3.8, 3), (0, 3))],
    "Q": [((1, 0.7), (4, 0.7)), ((4, 0.7), (5, 3.5)), ((5, 3.5), (4, 6.3)), ((4, 6.3), (1, 6.3)), ((1, 6.3), (0, 3.5)), ((0, 3.5), (1, 0.7)), ((3.2, 4.6), (5, 7))],
    "R": [((0, 7), (0, 0)), ((0, 0), (3.8, 0)), ((3.8, 0), (5, 1.5)), ((5, 1.5), (3.8, 3)), ((3.8, 3), (0, 3)), ((0, 3), (5, 7))],
    "S": [((5, 1), (3.8, 0)), ((3.8, 0), (1.2, 0)), ((1.2, 0), (0, 1.5)), ((0, 1.5), (1, 3.2)), ((1, 3.2), (4, 3.8)), ((4, 3.8), (5, 5.2)), ((5, 5.2), (3.8, 7)), ((3.8, 7), (1, 7))],
    "T": [((0, 0), (5, 0)), ((2.5, 0), (2.5, 7))],
    "U": [((0, 0), (0, 5.5)), ((0, 5.5), (1.2, 7)), ((1.2, 7), (3.8, 7)), ((3.8, 7), (5, 5.5)), ((5, 5.5), (5, 0))],
    "V": [((0, 0), (2.5, 7)), ((2.5, 7), (5, 0))],
    "W": [((0, 0), (1.2, 7)), ((1.2, 7), (2.5, 3.5)), ((2.5, 3.5), (3.8, 7)), ((3.8, 7), (5, 0))],
    "X": [((0, 0), (5, 7)), ((5, 0), (0, 7))],
    "Y": [((0, 0), (2.5, 3.5)), ((5, 0), (2.5, 3.5)), ((2.5, 3.5), (2.5, 7))],
    "Z": [((0, 0), (5, 0)), ((5, 0), (0, 7)), ((0, 7), (5, 7))],
    "0": [((1, 0.7), (4, 0.7)), ((4, 0.7), (5, 3.5)), ((5, 3.5), (4, 6.3)), ((4, 6.3), (1, 6.3)), ((1, 6.3), (0, 3.5)), ((0, 3.5), (1, 0.7)), ((1.2, 6.1), (3.8, 0.9))],
    "1": [((2.5, 0), (2.5, 7)), ((1.2, 1.2), (2.5, 0)), ((1, 7), (4, 7))],
    "2": [((0.6, 1.5), (1.6, 0)), ((1.6, 0), (4, 0)), ((4, 0), (5, 1.6)), ((5, 1.6), (0, 7)), ((0, 7), (5, 7))],
    "3": [((0.8, 0), (4.2, 0)), ((4.2, 0), (5, 1.6)), ((5, 1.6), (3.3, 3.5)), ((3.3, 3.5), (5, 5.4)), ((5, 5.4), (4.2, 7)), ((4.2, 7), (0.8, 7))],
    "4": [((4.2, 0), (4.2, 7)), ((0, 4.2), (5, 4.2)), ((0, 4.2), (3.8, 0))],
    "5": [((5, 0), (1, 0)), ((1, 0), (0.3, 3.1)), ((0.3, 3.1), (3.8, 3.1)), ((3.8, 3.1), (5, 4.6)), ((5, 4.6), (3.8, 7)), ((3.8, 7), (0.8, 7))],
    "6": [((5, 1), (3.8, 0)), ((3.8, 0), (1.1, 1.4)), ((1.1, 1.4), (0.2, 3.8)), ((0.2, 3.8), (1.1, 6.4)), ((1.1, 6.4), (3.8, 7)), ((3.8, 7), (5, 5.6)), ((5, 5.6), (3.8, 3.8)), ((3.8, 3.8), (0.7, 3.8))],
    "7": [((0, 0), (5, 0)), ((5, 0), (1.7, 7))],
    "8": [((1.2, 0), (3.8, 0)), ((3.8, 0), (5, 1.6)), ((5, 1.6), (3.8, 3.3)), ((3.8, 3.3), (1.2, 3.3)), ((1.2, 3.3), (0, 1.6)), ((0, 1.6), (1.2, 0)), ((1.2, 3.3), (0, 5.4)), ((0, 5.4), (1.2, 7)), ((1.2, 7), (3.8, 7)), ((3.8, 7), (5, 5.4)), ((5, 5.4), (3.8, 3.3))],
    "9": [((5, 3.2), (3.8, 0.8)), ((3.8, 0.8), (1.1, 0.8)), ((1.1, 0.8), (0.2, 3.2)), ((0.2, 3.2), (1.1, 4.8)), ((1.1, 4.8), (4.2, 4.8)), ((4.2, 4.8), (5, 7))],
    ".": [((2.5, 6.4), (2.5, 7))],
    "-": [((1, 3.5), (4, 3.5))],
    "_": [((0.4, 7), (4.6, 7))],
    "/": [((0.5, 7), (4.5, 0))],
    " ": [],
}


def glyph_strokes(ch: str) -> List[Tuple[Point, Point]]:
    base = GLYPHS.get(ch.upper())
    if base is not None:
        return base
    return [((0, 0), (5, 0)), ((5, 0), (5, 7)), ((5, 7), (0, 7)), ((0, 7), (0, 0)), ((0, 0), (5, 7))]


def _scale_point(p: Point, ox: float, oy: float, scale: float) -> Point:
    return (ox + p[0] * scale, oy + p[1] * scale)


def text_to_paths(text: str, x: float, y: float, size: float, font: str) -> List[Stroke]:
    if size <= 0:
        return []
    char_h = size
    scale = char_h / 7.0
    advance = 5.0 * scale
    gap = scale * (1.8 if font in {"monospace", "normal"} else 1.4)
    paths: List[Stroke] = []

    cx = x
    cy = y
    for ch in text:
        if ch == "\n":
            cx = x
            cy += char_h + (2.5 * scale)
            continue

        strokes = glyph_strokes(ch)
        for a, b in strokes:
            paths.append([
                [*_scale_point(a, cx, cy, scale)],
                [*_scale_point(b, cx, cy, scale)],
            ])
            if font == "bold":
                # Add a second, slightly offset stroke to imitate inner/outer trace.
                paths.append([
                    [*_scale_point(a, cx + scale * 0.6, cy + scale * 0.6, scale)],
                    [*_scale_point(b, cx + scale * 0.6, cy + scale * 0.6, scale)],
                ])

        cx += advance + gap

    return paths


def iter_text_paths(
    text: str,
    x: float,
    y: float,
    size: float,
    font: str,
) -> Iterable[Stroke]:
    for stroke in text_to_paths(text, x, y, size, font):
        yield stroke
